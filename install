#!/bin/bash
: '
Title           : install
Author          : Keisuke Suzuki
Created on      : 9/24/19
Description     : This script creates a directory and copies two files
                  to target directory, and an uninstall script. If
                  custom prefix is specified, it stores the program to
                  target-file-path/mysqlinsert, otherwise, in
                  $HOME/.mysqlinsert
'

target_dir="$1"
default_dir="$HOME/.mysqlinsert"
root="$PWD"
bin="$root/target/release/mysqlinsert"
env="$root/.env"
bash="$HOME/.bashrc"

function export_path() {
    echo "$bash"
    if [[ -f "$bash" ]]; then
        echo "export PATH=\"$target_dir/mysqlinsert:\$PATH\"" >> "$bash"
    elif [[ -f "$HOME/.profile" ]]; then
        bash="$HOME/.profile"
        echo "export \"PATH=$target_dir/mysqlinsert:$PATH\"" >> "$bash"
    else
        printf "neither .bashrc or .profile found in your home directory\n
              please manually add $target_dir to your PATH variable\n"

    fi
}

function ask_usr() {
    while true; do
        printf "Continue installing to %s?[y/n]: " "$default_dir"
        read -r input

        case "$input" in
            [yY]*)
                echo "installing to $default_dir"
                cp -r "$bin" "$env" "$default_dir"
                chmod -x "$default_dir/mysqlinsert"
                break
                ;;
            [nN]*)
                echo "Ok, exiting"
                exit 1
                ;;
            *)
                printf "please enter [y/n]: " >&2
                ;;
        esac
    done
}

function generate_uninstall() {

    line_to_delete="export PATH=\"$target_dir/mysqlinsert:\$PATH\""
    #replace '"' with '/"'
    line_to_delete=${line_to_delete//'"'/'\"'}
    #replace '/' with '\/'
    line_to_delete=${line_to_delete//'/'/'\/'}

    touch "$root/uninstall"
    echo "writing uninstall script to $root"

    echo   "#!/bin/bash"                    >"$root/uninstall"

    echo   ": 'Title           : uninstall" >> "$root/uninstall"

    printf "   Description     : This file is generated by running install file"\
                                            >> "$root/uninstall"

    printf "'\n\n"                          >> "$root/uninstall"

    echo   "#delete the directory the app is installed" \
                                            >> "$root/uninstall"
    printf "rm -r -f %s\n\n" "\"$target_dir\"">> "$root/uninstall"

    echo   "#remove export from .bashrc or .profile" \
                                            >> "$root/uninstall"
    printf "sed -e 's/%s//g' -i \"%s\"\n\n" "$line_to_delete" "$bash" \
                                            >> "$root/uninstall"
    echo   "echo \"uninstalled successfully\"" \
                                            >> "$root/uninstall"

    #for uninstall
    chmod +x uninstall
}

function install() {
    #arg is empty
    if [[ -z "$target_dir" ]]; then
        mkdir "$default_dir"
        cp -r "$bin" "$env" "$default_dir"
        target_dir="$default_dir"
    else
        #check custom if prefix path exists
        if [[ -d "$target_dir" ]] ; then
            echo "$target_dir found, installing to $target_dir"
            cp -r "$bin" "$env" "$target_dir"
        else
            echo "$target_dir not found."
            target_dir="$default_dir"
            #ask user to continue with default path
            ask_usr
        fi
    fi
    export_path
    generate_uninstall
    echo "uninstall script is generated"
    echo "mysqlinsert is installed to $target_dir"
}

install

